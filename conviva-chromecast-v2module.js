/*! (C) 2022 Conviva, Inc. All rights reserved. Confidential and proprietary. */
!function(t,i){"function"===typeof define&&define.amd?define(i):"object"===typeof exports&&(module.exports=i()),"undefined"!==typeof t&&("undefined"===typeof t.Conviva?void 0!==t.ConvivaModule||t.ConvivaModuleLoading||(t.ConvivaModuleLoading=!0,t.ConvivaModule=i(),delete t.ConvivaModuleLoading):void 0!==t.Conviva.ProxyMonitor||t.ConvivaModuleLoading||(i=i(),t.ConvivaModuleLoading=!0,t.Conviva.ProxyMonitor=i.ProxyMonitor,t.Conviva.Impl.V2Proxy=i.Impl.V2Proxy,delete t.ConvivaModuleLoading))}(this,function(){var s={};return function(){"use strict";function t(t,i,n,e,a){var h=this;h.t=[],h.i=0,h.n=0,h.e=!1,this.o=new a.Impl.Html5Timer,this.s=-1,this.r=-1,this.a=a.Constants.PlayerState.UNKNOWN,this.h=!1,this.u=0,this.f=-1,this.c="",this.d=!1,this.v=!1,this.y=0,this.l=0,this.N=0,this.P=0,this.p=function(){h.V("V2Proxy._setAllEventListeners()"),h.x&&(h.x.addEventListener("loadstart",h.onLoadstart),h.x.addEventListener("loadedmetadata",h.onLoadedMetadata),h.x.addEventListener("ended",h.onEnded),h.x.addEventListener("pause",h.onPause),h.x.addEventListener("timeupdate",h.onDurationchange),h.x.addEventListener("abort",h.onStalled),h.x.addEventListener("seeking",h.onSeeking),h.x.addEventListener("playing",h.onPlay),h.x.addEventListener("error",h.onError),h.x.addEventListener("seeked",h.onSeekComplete))},this._=function(){h.V("V2Proxy._removeAllEventListeners()"),h.x&&(h.x.removeEventListener("loadstart",h.onLoadstart),h.x.removeEventListener("loadedmetadata",h.onLoadedMetadata),h.x.removeEventListener("ended",h.onEnded),h.x.removeEventListener("pause",h.onPause),h.x.removeEventListener("timeupdate",h.onDurationchange),h.x.removeEventListener("abort",h.onStalled),h.x.removeEventListener("seeking",h.onSeeking),h.x.removeEventListener("play",h.onPlay),h.x.removeEventListener("error",h.onError),h.x.removeEventListener("seeked",h.onSeekComplete))},this.onLoadstart=function(){h.V("v2Proxy.onLoadstart"),h.d=!0,h.A(a.Constants.PlayerState.BUFFERING)},this.onLoadedMetadata=function(){h.V("v2Proxy.onLoadedMetadata"),h.R()},this.onDurationChange=function(){h.V("V2Proxy.onDurationchange"),h.I(),h.x&&h.R()},this.I=function(){if(h.C&&h.d&&h.C.getStreamingProtocol()&&"function"===typeof h.C.getStreamingProtocol().getStreamCount){for(var t=0,i=h.C.getStreamingProtocol().getStreamCount(),n=0;n<i;n++){var e=h.C.getStreamingProtocol().getStreamInfo(n);0!==e.mimeType.indexOf("video")&&0!==e.mimeType.indexOf("audio")||(e=h.C.getStreamingProtocol().getQualityLevel(n))>=0&&(t+=h.C.getStreamingProtocol().getStreamInfo(n).bitrates[e])}t>0&&t!==h.u&&(h.u=t,h.V("V2Proxy._updateBitrate"),h.M.reportPlaybackMetric(a.Constants.Playback.BITRATE,Math.round(h.u/1e3),"CONVIVA"))}},this.onPlay=function(){if(h.V("V2Proxy.onPlay"),h.firstPlay)return h.V("V2Proxy.onPlay :First Play IGNORED!!"),void(h.firstPlay=!1);h.A(a.Constants.PlayerState.PLAYING)},this.onStalled=function(){h.V("V2Proxy.onStalled - abort event"),h.A(a.Constants.PlayerState.STOPPED)},this.onPause=function(){h.V("v2Proxy.onPause"),h.C&&h.C.getState().underflow?h.A(a.Constants.PlayerState.BUFFERING):h.A(a.Constants.PlayerState.PAUSED)},this.onEnded=function(){h.V("v2Proxy.onMediaFinished"),h.x&&h.A(a.Constants.PlayerState.STOPPED)},this.onSeeking=function(){h.isSeekStarted||(h.isSeekStarted=!0,h.V("V2Proxy.onSeeking"),h.M.reportPlaybackMetric(a.Constants.Playback.SEEK_STARTED,"CONVIVA"))},this.onSeekComplete=function(){h.V("v2Proxy.onSeekComplete"),h.M.reportPlaybackMetric(a.Constants.Playback.SEEK_ENDED,"CONVIVA"),h.isSeekStarted=!1},this.onError=function(){var t;h.V("v2Proxy.onError"),h.x&&(t=h.x.error,t=h.O(t?t.code:99),h.M.reportPlaybackError(t,a.Constants.ErrorSeverity.FATAL))},this.O=function(t){var i;switch(t){case 0:i="MEDIA_ERR_CUSTOM";break;case 1:i="MEDIA_ERR_ABORTED";break;case 2:i="MEDIA_ERR_NETWORK";break;case 3:i="MEDIA_ERR_DECODE";break;case 4:i="MEDIA_ERR_SRC_NOT_SUPPORTED";break;default:i="MEDIA_ERR_UNKNOWN"}return h.V("MediaError: "+i),i},this.A=function(t){h.a=t,h.M.reportPlaybackMetric(a.Constants.Playback.PLAYER_STATE,t,"CONVIVA"),h.D(),h.k=!0},this.R=function(){var t,i;h.x&&("function"===typeof h.x.getVideoPlaybackQuality&&(t=h.x.getVideoPlaybackQuality().droppedVideoFrames,!isNaN(t)&&t>=0&&t!==h.N&&(h.N=t,h.M.reportPlaybackMetric(a.Constants.Playback.DROPPED_FRAMES_TOTAL,t,"CONVIVA"))),t=h.x.videoWidth,i=h.x.videoHeight,(!isNaN(t)&&t>0&&t!==h.s||!isNaN(i)&&i>0&&i!==h.r)&&(h.s=t,h.r=i,h.M.reportPlaybackMetric(a.Constants.Playback.RESOLUTION,t,i,"CONVIVA")),t={},h.x.duration>0&&((i=h.x.duration)!==h.f&&(h.f=i,t[a.Constants.DURATION]=i)),"{}"!==JSON.stringify(t)&&h.M.setContentInfo(t))},this.m=function(){var t;h.M&&((t={})[a.Constants.DeviceMetadata.TYPE]=a.Constants.DeviceType.SETTOP,t[a.Constants.DeviceMetadata.CATEGORY]=a.Constants.DeviceCategory.CHROMECAST,a.Analytics.setDeviceMetadata(t))},this.b=function(){this.g=0,this.w=0,this.S=0,this.L=this.o.createTimer(this.T,500,"v2Proxy._poll()")},this.T=function(){var t,i;h.M.reportPlaybackMetric(a.Constants.Playback.PLAY_HEAD_TIME,1e3*h.x.currentTime,"CONVIVA"),h.x&&"function"===typeof h.x.getVideoPlaybackQuality&&(h.P%2===0&&(i=(t=h.x.getVideoPlaybackQuality().droppedVideoFrames)-h.l,h.l=t,t=h.x.getVideoPlaybackQuality().totalVideoFrames,i=Math.floor(t-h.y-i),h.y=t,isNaN(i)),h.P++),h.I(),h.R(),h.F(),h.U()},this.F=function(){h.g=h.w,h.w=h.x.currentTime;var t,i=Date.now();h.j>0&&i>h.j&&(t=(t=(t=h.w-h.g)<0?0:t)/(i-h.j)*1e3,h.t.push(t)),h.j=i,h.t.length>Math.max(8,4)&&h.t.shift()},this.U=function(){var t=h.t.length;if(t>=Math.min(4,8)){for(var i=0,n=h.t.slice(),e=0;e<n.length;e++)i+=n[e];i/=t;var o=1,s=.25,r=h.x.playbackRate;if(!isNaN(r)&&r!==1/0&&r>0&&(o=o*r,s=s*r),h.a!==a.Constants.PlayerState.PLAYING&&t>=4&&Math.abs(i-o)<s)return h.V("Adjusting Conviva player state to: PLAYING"),void h.A(a.Constants.PlayerState.PLAYING);h.a===a.Constants.PlayerState.PLAYING&&t>=8&&0===i&&(h.V("Adjusting Conviva player state to: BUFFERING"),h.A(a.Constants.PlayerState.BUFFERING))}},this.B=function(){this.L&&this.L()},this.D=function(){h.t=[],h.g=-1,h.j=0},this.G=function(){h.n=0,h.i=0},this.V=function(t){this.K.log(t,a.SystemSettings.LogLevel.DEBUG)},function(t,i,n,e,o){if(!i)throw new Error("v2Proxy: mediaElement argument cannot be null.");this.x=i,this.C=t,this.M=e,this.K=n.buildLogger(),this.K.setModuleName("v2Proxy"),this.V("v2Proxy._constr()"),this.p(),this.D(),this.G(),this.b(),this.m(),(i={})[o.Constants.MODULE_NAME]="Chromecast V2 Receiver",i[o.Constants.MODULE_VERSION]="4.0.8",this.M.setContentInfo(i),(t={})[o.Constants.FRAMEWORK_NAME]="Cast Player","undefined"!==typeof cast.receiver&&(t[o.Constants.FRAMEWORK_VERSION]=cast.receiver.VERSION),this.M.setPlayerInfo(t)}.apply(this,arguments),this.cleanup=function(){this.V("v2Proxy.cleanup()"),this.B(),this._(),this.x=null}}s.ProxyMonitor={W:null,release:function(){this.W&&this.W.cleanup()},initConvivaDropIn:function(t,i,n,e,o){if(i)return this.W=new s.Impl.V2Proxy(t,i,n,e,o),this.W;throw new Error("No player proxy initialized")}},"undefined"!==typeof s&&(s.Impl=s.Impl||{},s.Impl.V2Proxy=t)}(),s});